[alert_test_generator]
action.email = 0
action.email.useNSSubject = 1
action.populate_lookup = 0
action.rss = 0
action.summary_index = 0
action.summary_index.force_realtime_schedule = 0
action.webhook.enable_allowlist = 1
alert.digest_mode = 1
alert.expires = 24h
alert.severity = 3
alert.track = 0
allow_skew = 5m
auto_summarize = 0
auto_summarize.command = | summarize override=partial timespan=$auto_summarize.timespan$ max_summary_size=$auto_summarize.max_summary_size$ max_summary_ratio=$auto_summarize.max_summary_ratio$ max_disabled_buckets=$auto_summarize.max_disabled_buckets$ max_time=$auto_summarize.max_time$ [ $search$ ]
auto_summarize.cron_schedule = */10 * * * *
auto_summarize.dispatch.time_format = %FT%T.%Q%:z
auto_summarize.dispatch.ttl = 60
auto_summarize.max_concurrent = 1
auto_summarize.max_disabled_buckets = 2
auto_summarize.max_summary_ratio = 0.1
auto_summarize.max_summary_size = 52428800
auto_summarize.max_time = 3600
auto_summarize.suspend_period = 24h
calculate_alert_required_fields_in_search = 1
counttype = always
cron_schedule = * * * * *
defer_scheduled_searchable_idxc = 0
description = set the state variable at the end to the desired pattern for testing
disabled = False
dispatch.allow_partial_results = 1
dispatch.auto_cancel = 0
dispatch.auto_pause = 0
dispatch.buckets = 0
dispatch.earliest_time = -30m@m
dispatch.latest_time = now
dispatch.lookups = 1
dispatch.max_count = 500000
dispatch.max_time = 0
dispatch.rate_limit_retry = 0
dispatch.reduce_freq = 10
dispatch.rt_backfill = 0
dispatch.sample_ratio = 1
dispatch.spawn_process = 1
dispatch.time_format = %FT%T.%Q%:z
dispatch.ttl = 2p
dispatchAs = owner
display.events.fields = ["host","source","sourcetype"]
display.events.list.drilldown = full
display.events.list.wrap = 1
display.events.maxLines = 5
display.events.raw.drilldown = full
display.events.rowNumbers = 0
display.events.table.drilldown = 1
display.events.table.wrap = 1
display.events.type = list
display.general.enablePreview = 1
display.general.migratedFromViewState = 0
display.general.timeRangePicker.show = 1
display.general.type = statistics
display.page.search.mode = verbose
display.page.search.patterns.sensitivity = 0.8
display.page.search.showFields = 1
display.page.search.tab = statistics
display.page.search.timeline.format = compact
display.page.search.timeline.scale = linear
display.statistics.drilldown = cell
display.statistics.overlay = none
display.statistics.percentagesRow = 0
display.statistics.rowNumbers = 0
display.statistics.show = 1
display.statistics.totalsRow = 0
display.statistics.wrap = 1
display.visualizations.chartHeight = 300
display.visualizations.charting.axisLabelsX.majorLabelStyle.overflowMode = ellipsisNone
display.visualizations.charting.axisLabelsX.majorLabelStyle.rotation = 0
display.visualizations.charting.axisTitleX.visibility = visible
display.visualizations.charting.axisTitleY.visibility = visible
display.visualizations.charting.axisTitleY2.visibility = visible
display.visualizations.charting.axisX.abbreviation = none
display.visualizations.charting.axisX.scale = linear
display.visualizations.charting.axisY.abbreviation = none
display.visualizations.charting.axisY.scale = linear
display.visualizations.charting.axisY2.abbreviation = none
display.visualizations.charting.axisY2.enabled = 0
display.visualizations.charting.axisY2.scale = inherit
display.visualizations.charting.chart = column
display.visualizations.charting.chart.bubbleMaximumSize = 50
display.visualizations.charting.chart.bubbleMinimumSize = 10
display.visualizations.charting.chart.bubbleSizeBy = area
display.visualizations.charting.chart.nullValueMode = gaps
display.visualizations.charting.chart.showDataLabels = none
display.visualizations.charting.chart.sliceCollapsingThreshold = 0.01
display.visualizations.charting.chart.stackMode = default
display.visualizations.charting.chart.style = shiny
display.visualizations.charting.drilldown = all
display.visualizations.charting.layout.splitSeries = 0
display.visualizations.charting.layout.splitSeries.allowIndependentYRanges = 0
display.visualizations.charting.legend.labelStyle.overflowMode = ellipsisMiddle
display.visualizations.charting.legend.mode = standard
display.visualizations.charting.legend.placement = right
display.visualizations.charting.lineWidth = 2
display.visualizations.custom.drilldown = all
display.visualizations.mapHeight = 400
display.visualizations.mapping.choroplethLayer.colorBins = 5
display.visualizations.mapping.choroplethLayer.colorMode = auto
display.visualizations.mapping.choroplethLayer.maximumColor = 0xaf575a
display.visualizations.mapping.choroplethLayer.minimumColor = 0x62b3b2
display.visualizations.mapping.choroplethLayer.neutralPoint = 0
display.visualizations.mapping.choroplethLayer.shapeOpacity = 0.75
display.visualizations.mapping.choroplethLayer.showBorder = 1
display.visualizations.mapping.data.maxClusters = 100
display.visualizations.mapping.drilldown = all
display.visualizations.mapping.legend.placement = bottomright
display.visualizations.mapping.map.center = (0,0)
display.visualizations.mapping.map.panning = 1
display.visualizations.mapping.map.scrollZoom = 0
display.visualizations.mapping.map.zoom = 2
display.visualizations.mapping.markerLayer.markerMaxSize = 50
display.visualizations.mapping.markerLayer.markerMinSize = 10
display.visualizations.mapping.markerLayer.markerOpacity = 0.8
display.visualizations.mapping.showTiles = 1
display.visualizations.mapping.tileLayer.maxZoom = 7
display.visualizations.mapping.tileLayer.minZoom = 0
display.visualizations.mapping.tileLayer.tileOpacity = 1
display.visualizations.mapping.type = marker
display.visualizations.show = 0
display.visualizations.singlevalue.colorBy = value
display.visualizations.singlevalue.colorMode = none
display.visualizations.singlevalue.drilldown = none
display.visualizations.singlevalue.numberPrecision = 0
display.visualizations.singlevalue.rangeColors = ["0x53a051", "0x0877a6", "0xf8be34", "0xf1813f", "0xdc4e41"]
display.visualizations.singlevalue.rangeValues = [0,30,70,100]
display.visualizations.singlevalue.showSparkline = 1
display.visualizations.singlevalue.showTrendIndicator = 1
display.visualizations.singlevalue.trendColorInterpretation = standard
display.visualizations.singlevalue.trendDisplayMode = absolute
display.visualizations.singlevalue.unitPosition = after
display.visualizations.singlevalue.useColors = 0
display.visualizations.singlevalue.useThousandSeparators = 1
display.visualizations.singlevalueHeight = 115
display.visualizations.trellis.enabled = 0
display.visualizations.trellis.scales.shared = 1
display.visualizations.trellis.size = medium
display.visualizations.type = charting
durable.backfill_type = auto
durable.lag_time = 0
durable.max_backfill_intervals = 0
embed.enabled = 0
enableSched = 1
is_visible = 1
max_concurrent = 1
precalculate_required_fields_for_alerts = 1
realtime_schedule = 1
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search
restart_on_searchpeer_add = 1
run_n_times = 0
run_on_startup = 0
schedule_as = auto
schedule_priority = default
schedule_window = auto
search = | inputlookup alert_test.csv\
``` set the profile and then look at the deep dives to see what the data really did ```\
| eval _time=now(), min=strftime(now(), "%M"), hr=strftime(now(), "%H"), tt=tonumber(strftime(now(), "%M%S"))/10000\
``` state_cycle is good for 1 and 5 minute tests, it generates down events fairly consistently for the 1st and 3rd quarter of each hour on all entities```\
| eval state_cycle=case(random()%2==0 AND floor(min/15)%2=1, random()%3+3,  \
                  min IN (0,1,2,13,14,15,16, 43,44,45,46, 47,58,59) AND c < 3, random()%2+3,\
                  1==1, 2)+tt\
``` state_down generates MAJOR alerts on entity 1, minor on entity 2 and either on entity 3.  4 and 5 are green ```                  \
,  state_down=case(c==1, random()%2+5,\
              c==2, random()%2+3,\
              min%10 < -2 AND c=="3", 2,\
              c==3, random()%4+3,\
              1==1, 2)+tt,\
``` better for testing 15 minute over long period ```              \
    state_long=if(hr%4==0  OR hr==3 AND min>40 OR hr==5 AND min > 40, 2+tt, \
               state_cycle),\
    state_up=2+tt,\
    state=state_down\
| outputlookup alert_test.csv
skip_scheduled_realtime_idxc = 0

[alert_test_service_creation]
action.email = 0
action.email.useNSSubject = 1
action.populate_lookup = 0
action.rss = 0
action.summary_index = 0
action.summary_index.force_realtime_schedule = 0
action.webhook.enable_allowlist = 0
alert.digest_mode = 1
alert.expires = 24h
alert.severity = 3
alert.track = 0
allow_skew = 0
auto_summarize = 0
auto_summarize.command = | summarize override=partial timespan=$auto_summarize.timespan$ max_summary_size=$auto_summarize.max_summary_size$ max_summary_ratio=$auto_summarize.max_summary_ratio$ max_disabled_buckets=$auto_summarize.max_disabled_buckets$ max_time=$auto_summarize.max_time$ [ $search$ ]
auto_summarize.cron_schedule = */10 * * * *
auto_summarize.dispatch.time_format = %FT%T.%Q%:z
auto_summarize.dispatch.ttl = 60
auto_summarize.max_concurrent = 1
auto_summarize.max_disabled_buckets = 2
auto_summarize.max_summary_ratio = 0.1
auto_summarize.max_summary_size = 52428800
auto_summarize.max_time = 3600
auto_summarize.suspend_period = 24h
counttype = always
defer_scheduled_searchable_idxc = 0
disabled = True
dispatch.allow_partial_results = 1
dispatch.auto_cancel = 0
dispatch.auto_pause = 0
dispatch.buckets = 0
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
dispatch.lookups = 1
dispatch.max_count = 500000
dispatch.max_time = 0
dispatch.rate_limit_retry = 0
dispatch.reduce_freq = 10
dispatch.rt_backfill = 0
dispatch.sample_ratio = 1
dispatch.spawn_process = 1
dispatch.time_format = %FT%T.%Q%:z
dispatch.ttl = 2p
dispatchAs = owner
display.events.fields = ["host","source","sourcetype","punct"]
display.events.list.drilldown = full
display.events.list.wrap = 1
display.events.maxLines = 5
display.events.raw.drilldown = full
display.events.rowNumbers = 0
display.events.table.drilldown = 1
display.events.table.wrap = 1
display.events.type = list
display.general.enablePreview = 1
display.general.migratedFromViewState = 0
display.general.timeRangePicker.show = 1
display.general.type = statistics
display.page.search.mode = verbose
display.page.search.patterns.sensitivity = 0.8
display.page.search.showFields = 1
display.page.search.tab = statistics
display.page.search.timeline.format = compact
display.page.search.timeline.scale = linear
display.statistics.drilldown = cell
display.statistics.overlay = none
display.statistics.percentagesRow = 0
display.statistics.rowNumbers = 0
display.statistics.show = 1
display.statistics.totalsRow = 0
display.statistics.wrap = 1
display.visualizations.chartHeight = 300
display.visualizations.charting.axisLabelsX.majorLabelStyle.overflowMode = ellipsisNone
display.visualizations.charting.axisLabelsX.majorLabelStyle.rotation = 0
display.visualizations.charting.axisTitleX.visibility = visible
display.visualizations.charting.axisTitleY.visibility = visible
display.visualizations.charting.axisTitleY2.visibility = visible
display.visualizations.charting.axisX.abbreviation = none
display.visualizations.charting.axisX.scale = linear
display.visualizations.charting.axisY.abbreviation = none
display.visualizations.charting.axisY.scale = linear
display.visualizations.charting.axisY2.abbreviation = none
display.visualizations.charting.axisY2.enabled = 0
display.visualizations.charting.axisY2.scale = inherit
display.visualizations.charting.chart = column
display.visualizations.charting.chart.bubbleMaximumSize = 50
display.visualizations.charting.chart.bubbleMinimumSize = 10
display.visualizations.charting.chart.bubbleSizeBy = area
display.visualizations.charting.chart.nullValueMode = gaps
display.visualizations.charting.chart.showDataLabels = none
display.visualizations.charting.chart.sliceCollapsingThreshold = 0.01
display.visualizations.charting.chart.stackMode = default
display.visualizations.charting.chart.style = shiny
display.visualizations.charting.drilldown = all
display.visualizations.charting.layout.splitSeries = 0
display.visualizations.charting.layout.splitSeries.allowIndependentYRanges = 0
display.visualizations.charting.legend.labelStyle.overflowMode = ellipsisMiddle
display.visualizations.charting.legend.mode = standard
display.visualizations.charting.legend.placement = right
display.visualizations.charting.lineWidth = 2
display.visualizations.custom.drilldown = all
display.visualizations.mapHeight = 400
display.visualizations.mapping.choroplethLayer.colorBins = 5
display.visualizations.mapping.choroplethLayer.colorMode = auto
display.visualizations.mapping.choroplethLayer.maximumColor = 0xaf575a
display.visualizations.mapping.choroplethLayer.minimumColor = 0x62b3b2
display.visualizations.mapping.choroplethLayer.neutralPoint = 0
display.visualizations.mapping.choroplethLayer.shapeOpacity = 0.75
display.visualizations.mapping.choroplethLayer.showBorder = 1
display.visualizations.mapping.data.maxClusters = 100
display.visualizations.mapping.drilldown = all
display.visualizations.mapping.legend.placement = bottomright
display.visualizations.mapping.map.center = (0,0)
display.visualizations.mapping.map.panning = 1
display.visualizations.mapping.map.scrollZoom = 0
display.visualizations.mapping.map.zoom = 2
display.visualizations.mapping.markerLayer.markerMaxSize = 50
display.visualizations.mapping.markerLayer.markerMinSize = 10
display.visualizations.mapping.markerLayer.markerOpacity = 0.8
display.visualizations.mapping.showTiles = 1
display.visualizations.mapping.tileLayer.maxZoom = 7
display.visualizations.mapping.tileLayer.minZoom = 0
display.visualizations.mapping.tileLayer.tileOpacity = 1
display.visualizations.mapping.type = marker
display.visualizations.show = 0
display.visualizations.singlevalue.colorBy = value
display.visualizations.singlevalue.colorMode = none
display.visualizations.singlevalue.drilldown = none
display.visualizations.singlevalue.numberPrecision = 0
display.visualizations.singlevalue.rangeColors = ["0x53a051", "0x0877a6", "0xf8be34", "0xf1813f", "0xdc4e41"]
display.visualizations.singlevalue.rangeValues = [0,30,70,100]
display.visualizations.singlevalue.showSparkline = 1
display.visualizations.singlevalue.showTrendIndicator = 1
display.visualizations.singlevalue.trendColorInterpretation = standard
display.visualizations.singlevalue.trendDisplayMode = absolute
display.visualizations.singlevalue.unitPosition = after
display.visualizations.singlevalue.useColors = 0
display.visualizations.singlevalue.useThousandSeparators = 1
display.visualizations.singlevalueHeight = 115
display.visualizations.trellis.enabled = 0
display.visualizations.trellis.scales.shared = 1
display.visualizations.trellis.size = medium
display.visualizations.type = charting
durable.backfill_type = auto
durable.lag_time = 0
durable.max_backfill_intervals = 0
embed.enabled = 0
enableSched = 0
is_visible = 1
max_concurrent = 1
precalculate_required_fields_for_alerts = 1
realtime_schedule = 1
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search
restart_on_searchpeer_add = 1
run_n_times = 0
run_on_startup = 0
schedule_as = auto
schedule_priority = default
schedule_window = 0
search = | makeresults | eval test=mvappend("0/0", "0/1", "1/0", "1/1", "2/2", "5/2", "2/5"), int="5min" | mvexpand test\
| eval service=printf("Alerting Tests - (%s) %s", test, int), template="alert_test-".int\
| appendpipe [| eval child=service, service="Alerting Tests ".int | stats values(child) as children by service | eval  children=mvjoin(children, ",")]\
```| itsiimportobjects\
    serviceEnabled=1\
    serviceTagsFields=test\
    serviceTemplateField=template\
    serviceTitleField=service\
    serviceDependentsFields=children\
    updateType=upsert```
skip_scheduled_realtime_idxc = 0

[Sustained Entity Degraded Metrics]
action.email = 0
action.email.useNSSubject = 1
action.populate_lookup = 0
action.rss = 0
action.summary_index = 0
action.summary_index.force_realtime_schedule = 0
action.webhook.enable_allowlist = 0
alert.digest_mode = 1
alert.expires = 24h
alert.severity = 3
alert.track = 0
allow_skew = 0
auto_summarize = 0
auto_summarize.command = | summarize override=partial timespan=$auto_summarize.timespan$ max_summary_size=$auto_summarize.max_summary_size$ max_summary_ratio=$auto_summarize.max_summary_ratio$ max_disabled_buckets=$auto_summarize.max_disabled_buckets$ max_time=$auto_summarize.max_time$ [ $search$ ]
auto_summarize.cron_schedule = */10 * * * *
auto_summarize.dispatch.time_format = %FT%T.%Q%:z
auto_summarize.dispatch.ttl = 60
auto_summarize.max_concurrent = 1
auto_summarize.max_disabled_buckets = 2
auto_summarize.max_summary_ratio = 0.1
auto_summarize.max_summary_size = 52428800
auto_summarize.max_time = 3600
auto_summarize.suspend_period = 24h
counttype = always
defer_scheduled_searchable_idxc = 0
description = finds ITSI entities with KPI that are unhealthy in the past $window$ minutes for $alert_period$
disabled = False
dispatch.allow_partial_results = 1
dispatch.auto_cancel = 0
dispatch.auto_pause = 0
dispatch.buckets = 0
dispatch.earliest_time = -10m
dispatch.latest_time = now
dispatch.lookups = 1
dispatch.max_count = 500000
dispatch.max_time = 0
dispatch.rate_limit_retry = 0
dispatch.reduce_freq = 10
dispatch.rt_backfill = 0
dispatch.sample_ratio = 1
dispatch.spawn_process = 1
dispatch.time_format = %FT%T.%Q%:z
dispatch.ttl = 2p
dispatchAs = owner
display.events.fields = ["host","source","sourcetype","punct"]
display.events.list.drilldown = full
display.events.list.wrap = 1
display.events.maxLines = 5
display.events.raw.drilldown = full
display.events.rowNumbers = 0
display.events.table.drilldown = 1
display.events.table.wrap = 1
display.events.type = list
display.general.enablePreview = 1
display.general.migratedFromViewState = 0
display.general.timeRangePicker.show = 1
display.general.type = statistics
display.page.search.mode = verbose
display.page.search.patterns.sensitivity = 0.8
display.page.search.showFields = 1
display.page.search.tab = statistics
display.page.search.timeline.format = compact
display.page.search.timeline.scale = linear
display.statistics.drilldown = cell
display.statistics.overlay = none
display.statistics.percentagesRow = 0
display.statistics.rowNumbers = 0
display.statistics.show = 1
display.statistics.totalsRow = 0
display.statistics.wrap = 1
display.visualizations.chartHeight = 300
display.visualizations.charting.axisLabelsX.majorLabelStyle.overflowMode = ellipsisNone
display.visualizations.charting.axisLabelsX.majorLabelStyle.rotation = 0
display.visualizations.charting.axisTitleX.visibility = visible
display.visualizations.charting.axisTitleY.visibility = visible
display.visualizations.charting.axisTitleY2.visibility = visible
display.visualizations.charting.axisX.abbreviation = none
display.visualizations.charting.axisX.scale = linear
display.visualizations.charting.axisY.abbreviation = none
display.visualizations.charting.axisY.scale = linear
display.visualizations.charting.axisY2.abbreviation = none
display.visualizations.charting.axisY2.enabled = 0
display.visualizations.charting.axisY2.scale = inherit
display.visualizations.charting.chart = column
display.visualizations.charting.chart.bubbleMaximumSize = 50
display.visualizations.charting.chart.bubbleMinimumSize = 10
display.visualizations.charting.chart.bubbleSizeBy = area
display.visualizations.charting.chart.nullValueMode = gaps
display.visualizations.charting.chart.showDataLabels = none
display.visualizations.charting.chart.sliceCollapsingThreshold = 0.01
display.visualizations.charting.chart.stackMode = default
display.visualizations.charting.chart.style = shiny
display.visualizations.charting.drilldown = all
display.visualizations.charting.layout.splitSeries = 0
display.visualizations.charting.layout.splitSeries.allowIndependentYRanges = 0
display.visualizations.charting.legend.labelStyle.overflowMode = ellipsisMiddle
display.visualizations.charting.legend.mode = standard
display.visualizations.charting.legend.placement = right
display.visualizations.charting.lineWidth = 2
display.visualizations.custom.drilldown = all
display.visualizations.mapHeight = 400
display.visualizations.mapping.choroplethLayer.colorBins = 5
display.visualizations.mapping.choroplethLayer.colorMode = auto
display.visualizations.mapping.choroplethLayer.maximumColor = 0xaf575a
display.visualizations.mapping.choroplethLayer.minimumColor = 0x62b3b2
display.visualizations.mapping.choroplethLayer.neutralPoint = 0
display.visualizations.mapping.choroplethLayer.shapeOpacity = 0.75
display.visualizations.mapping.choroplethLayer.showBorder = 1
display.visualizations.mapping.data.maxClusters = 100
display.visualizations.mapping.drilldown = all
display.visualizations.mapping.legend.placement = bottomright
display.visualizations.mapping.map.center = (0,0)
display.visualizations.mapping.map.panning = 1
display.visualizations.mapping.map.scrollZoom = 0
display.visualizations.mapping.map.zoom = 2
display.visualizations.mapping.markerLayer.markerMaxSize = 50
display.visualizations.mapping.markerLayer.markerMinSize = 10
display.visualizations.mapping.markerLayer.markerOpacity = 0.8
display.visualizations.mapping.showTiles = 1
display.visualizations.mapping.tileLayer.maxZoom = 7
display.visualizations.mapping.tileLayer.minZoom = 0
display.visualizations.mapping.tileLayer.tileOpacity = 1
display.visualizations.mapping.type = marker
display.visualizations.show = 0
display.visualizations.singlevalue.colorBy = value
display.visualizations.singlevalue.colorMode = none
display.visualizations.singlevalue.drilldown = none
display.visualizations.singlevalue.numberPrecision = 0
display.visualizations.singlevalue.rangeColors = ["0x53a051", "0x0877a6", "0xf8be34", "0xf1813f", "0xdc4e41"]
display.visualizations.singlevalue.rangeValues = [0,30,70,100]
display.visualizations.singlevalue.showSparkline = 1
display.visualizations.singlevalue.showTrendIndicator = 1
display.visualizations.singlevalue.trendColorInterpretation = standard
display.visualizations.singlevalue.trendDisplayMode = absolute
display.visualizations.singlevalue.unitPosition = after
display.visualizations.singlevalue.useColors = 0
display.visualizations.singlevalue.useThousandSeparators = 1
display.visualizations.singlevalueHeight = 115
display.visualizations.trellis.enabled = 0
display.visualizations.trellis.scales.shared = 1
display.visualizations.trellis.size = medium
display.visualizations.type = charting
durable.backfill_type = auto
durable.lag_time = 0
durable.max_backfill_intervals = 0
embed.enabled = 0
enableSched = 0
is_visible = 1
max_concurrent = 1
precalculate_required_fields_for_alerts = 1
realtime_schedule = 1
request.ui_dispatch_app = itsi
request.ui_dispatch_view = search
restart_on_searchpeer_add = 1
run_n_times = 0
run_on_startup = 0
schedule_as = auto
schedule_priority = default
schedule_window = 0
search = | mstats latest(alert_level) as alert_level where index="itsi_summary_metrics" AND is_service_aggregate=0 AND is_service_disabled=0 AND earliest=-$window$m\
            [| mstats latest(alert_level) as alert_level where index="itsi_summary_metrics" AND is_service_aggregate=0 AND is_service_disabled=0 AND alert_period=$alert_period$ AND earliest=-$kpi_lookback$m\
                       by itsi_kpi_id, itsi_service_id, entity_title| where alert_level > `itsi_sev_normal` | fields itsi_kpi_id, itsi_service_id, entity_title | format ]\
by kpi, itsi_kpi_id, itsi_service_id, entity_key, entity_title span=$alert_period$m \
| rangemap field=alert_level major=5-999 minor=3-4 default=ok  ``` define 3 levels of impact major (5+), minor(3-4) and ok (<=2)```\
| rename range as impact\
| eval is_degraded=if(alert_level>`itsi_sev_normal`, 1, 0)\
| sort 0 itsi_service_id kpi entity_title _time     ``` find out the time (and event count) the metric has been at its current impact level ```\
| streamstats first(_time) as streak_start count as streak_length by impact itsi_service_id kpi entity_title reset_on_change=true\
``` 2nd streamstats counts how long its been unhealthy, not just at the current major/minor level ```\
| streamstats first(_time) as streak_start_deg count as streak_length_deg by is_degraded itsi_service_id kpi entity_title reset_on_change=true\
| eventstats avg(alert_level) as avg_alert_level,       ``` is it stable (=alert_level) or moving? ```\
             max(alert_level) as max_alert_level,       ``` how bad has it been ```\
             latest(alert_level) as last_alert_level,   ``` current alert level ```\
             max(streak_length) as streak_length        ``` number of events at this level ```\
             by itsi_service_id kpi itsi_kpi_id entity_title streak_start impact\
| rename itsi_kpi_id as kpiid ``` it gets regenerated below in macros ```\
| sort - streak_start, _time  ``` to keep just the latest events ```\
| dedup itsi_service_id kpi entity_title\
| `add_universal_alert_fields_to_notable($name$)` ``` Add the UA gubbins ```\
| `add_event_type`                                ``` add the groupingid ```\
| eval itsiNotableTitle=printf("\"%s\":\"%s\" entity \"%s\" has been degraded for %s/%d events", service_name, kpi, entity_title, min(streak_length_deg, $window$), round($window$/$alert_period$))\
| eval itsiDescription=printf("Impact:%s, Alert Level: %d, Max Alert Level: %d, Average Alert Level: %d, Window:$window$, Alert Period:$alert_period$", impact, alert_level, round(avg_alert_level), round(max_alert_level, 2)) \
| eval entity_name=entity_title                   ``` work around the MW logic dropping needed fields ```\
| eval tmp_serviceid=serviceid,  tmp_entity_title=entity_title\
| `apply_entity_lookup(entity_name)`                  ``` lookup service details and do MW tasks ```\
| eval serviceid=coalesce(serviceid, tmp_serviceid),  ``` return the needed fields stripped by last macro ```\
       entity_title=coalesce(entity_title, tmp_entity_title)
skip_scheduled_realtime_idxc = 0

[ITSI Episode Contact Map Generator - v2]
action.email = 0
action.email.useNSSubject = 1
action.populate_lookup = 0
action.rss = 0
action.summary_index = 0
action.summary_index.force_realtime_schedule = 0
action.webhook.enable_allowlist = 1
alert.digest_mode = 1
alert.expires = 24h
alert.severity = 3
alert.track = 0
allow_skew = 5m
auto_summarize = 0
auto_summarize.command = | summarize override=partial timespan=$auto_summarize.timespan$ max_summary_size=$auto_summarize.max_summary_size$ max_summary_ratio=$auto_summarize.max_summary_ratio$ max_disabled_buckets=$auto_summarize.max_disabled_buckets$ max_time=$auto_summarize.max_time$ [ $search$ ]
auto_summarize.cron_schedule = */10 * * * *
auto_summarize.dispatch.time_format = %FT%T.%Q%:z
auto_summarize.dispatch.ttl = 60
auto_summarize.max_concurrent = 1
auto_summarize.max_disabled_buckets = 2
auto_summarize.max_summary_ratio = 0.1
auto_summarize.max_summary_size = 52428800
auto_summarize.max_time = 3600
auto_summarize.suspend_period = 24h
counttype = always
cron_schedule = 0 */4 * * *
defer_scheduled_searchable_idxc = 0
description = Extends the CPMA search and adds xmatters config
disabled = False
dispatch.allow_partial_results = 1
dispatch.auto_cancel = 0
dispatch.auto_pause = 0
dispatch.buckets = 0
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
dispatch.lookups = 1
dispatch.max_count = 500000
dispatch.max_time = 0
dispatch.rate_limit_retry = 0
dispatch.reduce_freq = 10
dispatch.rt_backfill = 0
dispatch.sample_ratio = 1
dispatch.spawn_process = 1
dispatch.time_format = %FT%T.%Q%:z
dispatch.ttl = 2p
dispatchAs = owner
display.events.fields = ["host","source","sourcetype"]
display.events.list.drilldown = full
display.events.list.wrap = 1
display.events.maxLines = 5
display.events.raw.drilldown = full
display.events.rowNumbers = 0
display.events.table.drilldown = 1
display.events.table.wrap = 1
display.events.type = list
display.general.enablePreview = 1
display.general.migratedFromViewState = 0
display.general.timeRangePicker.show = 1
display.general.type = statistics
display.page.search.mode = verbose
display.page.search.patterns.sensitivity = 0.8
display.page.search.showFields = 1
display.page.search.tab = statistics
display.page.search.timeline.format = compact
display.page.search.timeline.scale = linear
display.statistics.drilldown = cell
display.statistics.overlay = none
display.statistics.percentagesRow = 0
display.statistics.rowNumbers = 0
display.statistics.show = 1
display.statistics.totalsRow = 0
display.statistics.wrap = 1
display.visualizations.chartHeight = 300
display.visualizations.charting.axisLabelsX.majorLabelStyle.overflowMode = ellipsisNone
display.visualizations.charting.axisLabelsX.majorLabelStyle.rotation = 0
display.visualizations.charting.axisTitleX.visibility = visible
display.visualizations.charting.axisTitleY.visibility = visible
display.visualizations.charting.axisTitleY2.visibility = visible
display.visualizations.charting.axisX.abbreviation = none
display.visualizations.charting.axisX.scale = linear
display.visualizations.charting.axisY.abbreviation = none
display.visualizations.charting.axisY.scale = linear
display.visualizations.charting.axisY2.abbreviation = none
display.visualizations.charting.axisY2.enabled = 0
display.visualizations.charting.axisY2.scale = inherit
display.visualizations.charting.chart = line
display.visualizations.charting.chart.bubbleMaximumSize = 50
display.visualizations.charting.chart.bubbleMinimumSize = 10
display.visualizations.charting.chart.bubbleSizeBy = area
display.visualizations.charting.chart.nullValueMode = gaps
display.visualizations.charting.chart.showDataLabels = none
display.visualizations.charting.chart.sliceCollapsingThreshold = 0.01
display.visualizations.charting.chart.stackMode = default
display.visualizations.charting.chart.style = shiny
display.visualizations.charting.drilldown = all
display.visualizations.charting.layout.splitSeries = 0
display.visualizations.charting.layout.splitSeries.allowIndependentYRanges = 0
display.visualizations.charting.legend.labelStyle.overflowMode = ellipsisMiddle
display.visualizations.charting.legend.mode = standard
display.visualizations.charting.legend.placement = right
display.visualizations.charting.lineWidth = 2
display.visualizations.custom.drilldown = all
display.visualizations.mapHeight = 400
display.visualizations.mapping.choroplethLayer.colorBins = 5
display.visualizations.mapping.choroplethLayer.colorMode = auto
display.visualizations.mapping.choroplethLayer.maximumColor = 0xaf575a
display.visualizations.mapping.choroplethLayer.minimumColor = 0x62b3b2
display.visualizations.mapping.choroplethLayer.neutralPoint = 0
display.visualizations.mapping.choroplethLayer.shapeOpacity = 0.75
display.visualizations.mapping.choroplethLayer.showBorder = 1
display.visualizations.mapping.data.maxClusters = 100
display.visualizations.mapping.drilldown = all
display.visualizations.mapping.legend.placement = bottomright
display.visualizations.mapping.map.center = (0,0)
display.visualizations.mapping.map.panning = 1
display.visualizations.mapping.map.scrollZoom = 0
display.visualizations.mapping.map.zoom = 2
display.visualizations.mapping.markerLayer.markerMaxSize = 50
display.visualizations.mapping.markerLayer.markerMinSize = 10
display.visualizations.mapping.markerLayer.markerOpacity = 0.8
display.visualizations.mapping.showTiles = 1
display.visualizations.mapping.tileLayer.maxZoom = 7
display.visualizations.mapping.tileLayer.minZoom = 0
display.visualizations.mapping.tileLayer.tileOpacity = 1
display.visualizations.mapping.type = marker
display.visualizations.show = 0
display.visualizations.singlevalue.colorBy = value
display.visualizations.singlevalue.colorMode = none
display.visualizations.singlevalue.drilldown = none
display.visualizations.singlevalue.numberPrecision = 0
display.visualizations.singlevalue.rangeColors = ["0x53a051", "0x0877a6", "0xf8be34", "0xf1813f", "0xdc4e41"]
display.visualizations.singlevalue.rangeValues = [0,30,70,100]
display.visualizations.singlevalue.showSparkline = 1
display.visualizations.singlevalue.showTrendIndicator = 1
display.visualizations.singlevalue.trendColorInterpretation = standard
display.visualizations.singlevalue.trendDisplayMode = absolute
display.visualizations.singlevalue.unitPosition = after
display.visualizations.singlevalue.useColors = 0
display.visualizations.singlevalue.useThousandSeparators = 1
display.visualizations.singlevalueHeight = 115
display.visualizations.trellis.enabled = 0
display.visualizations.trellis.scales.shared = 1
display.visualizations.trellis.size = medium
display.visualizations.type = charting
durable.backfill_type = auto
durable.lag_time = 0
durable.max_backfill_intervals = 0
embed.enabled = 0
enableSched = 1
is_visible = 1
max_concurrent = 1
precalculate_required_fields_for_alerts = 1
realtime_schedule = 1
request.ui_dispatch_app = itsi_aiops_alerting_content_pack
request.ui_dispatch_view = search
restart_on_searchpeer_add = 1
run_n_times = 0
run_on_startup = 0
schedule_as = auto
schedule_priority = default
schedule_window = auto
search = | inputlookup itsi_kpi_attributes\
| dedup alert_group\
| eval original_data = 1\
| inputlookup append=true itsi_episode_contact_map\
| eventstats values(xmatters_detail) as xmatters_detail values(episode_contact_method) as episode_contact_method values(episode_contact_detail) as episode_contact_detail by alert_group\
| eval episode_contact_method = if(alert_group="ITSI Service Monitoring", coalesce(episode_contact_method, "email"), episode_contact_method)\
| eval episode_contact_detail = if(alert_group="ITSI Service Monitoring", coalesce(episode_contact_detail, "sample-email@companyemail.com"), episode_contact_detail)\
| search original_data=1\
| table alert_group episode_contact_method episode_contact_detail xmatters_detail\
| outputlookup itsi_episode_contact_map
skip_scheduled_realtime_idxc = 0

[ITSI KPI Attributes Lookup Generator - v2]
action.email = 0
action.email.useNSSubject = 1
action.populate_lookup = 0
action.rss = 0
action.summary_index = 0
action.summary_index.force_realtime_schedule = 0
action.webhook.enable_allowlist = 1
alert.digest_mode = 1
alert.expires = 24h
alert.severity = 3
alert.track = 0
allow_skew = 5m
auto_summarize = 0
auto_summarize.command = | summarize override=partial timespan=$auto_summarize.timespan$ max_summary_size=$auto_summarize.max_summary_size$ max_summary_ratio=$auto_summarize.max_summary_ratio$ max_disabled_buckets=$auto_summarize.max_disabled_buckets$ max_time=$auto_summarize.max_time$ [ $search$ ]
auto_summarize.cron_schedule = */10 * * * *
auto_summarize.dispatch.time_format = %FT%T.%Q%:z
auto_summarize.dispatch.ttl = 60
auto_summarize.max_concurrent = 1
auto_summarize.max_disabled_buckets = 2
auto_summarize.max_summary_ratio = 0.1
auto_summarize.max_summary_size = 52428800
auto_summarize.max_time = 3600
auto_summarize.suspend_period = 24h
counttype = always
cron_schedule = 0 */4 * * *
defer_scheduled_searchable_idxc = 0
description = Extends CPMA search to add threshold and suppress_period
disabled = False
dispatch.allow_partial_results = 1
dispatch.auto_cancel = 0
dispatch.auto_pause = 0
dispatch.buckets = 0
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
dispatch.lookups = 1
dispatch.max_count = 500000
dispatch.max_time = 0
dispatch.rate_limit_retry = 0
dispatch.reduce_freq = 10
dispatch.rt_backfill = 0
dispatch.sample_ratio = 1
dispatch.spawn_process = 1
dispatch.time_format = %FT%T.%Q%:z
dispatch.ttl = 2p
dispatchAs = owner
display.events.fields = ["host","source","sourcetype"]
display.events.list.drilldown = full
display.events.list.wrap = 1
display.events.maxLines = 5
display.events.raw.drilldown = full
display.events.rowNumbers = 0
display.events.table.drilldown = 1
display.events.table.wrap = 1
display.events.type = list
display.general.enablePreview = 1
display.general.migratedFromViewState = 0
display.general.timeRangePicker.show = 1
display.general.type = statistics
display.page.search.mode = verbose
display.page.search.patterns.sensitivity = 0.8
display.page.search.showFields = 1
display.page.search.tab = statistics
display.page.search.timeline.format = compact
display.page.search.timeline.scale = linear
display.statistics.drilldown = cell
display.statistics.overlay = none
display.statistics.percentagesRow = 0
display.statistics.rowNumbers = 0
display.statistics.show = 1
display.statistics.totalsRow = 0
display.statistics.wrap = 1
display.visualizations.chartHeight = 300
display.visualizations.charting.axisLabelsX.majorLabelStyle.overflowMode = ellipsisNone
display.visualizations.charting.axisLabelsX.majorLabelStyle.rotation = 0
display.visualizations.charting.axisTitleX.visibility = visible
display.visualizations.charting.axisTitleY.visibility = visible
display.visualizations.charting.axisTitleY2.visibility = visible
display.visualizations.charting.axisX.abbreviation = none
display.visualizations.charting.axisX.scale = linear
display.visualizations.charting.axisY.abbreviation = none
display.visualizations.charting.axisY.scale = linear
display.visualizations.charting.axisY2.abbreviation = none
display.visualizations.charting.axisY2.enabled = 0
display.visualizations.charting.axisY2.scale = inherit
display.visualizations.charting.chart = column
display.visualizations.charting.chart.bubbleMaximumSize = 50
display.visualizations.charting.chart.bubbleMinimumSize = 10
display.visualizations.charting.chart.bubbleSizeBy = area
display.visualizations.charting.chart.nullValueMode = gaps
display.visualizations.charting.chart.showDataLabels = none
display.visualizations.charting.chart.sliceCollapsingThreshold = 0.01
display.visualizations.charting.chart.stackMode = default
display.visualizations.charting.chart.style = shiny
display.visualizations.charting.drilldown = all
display.visualizations.charting.layout.splitSeries = 0
display.visualizations.charting.layout.splitSeries.allowIndependentYRanges = 0
display.visualizations.charting.legend.labelStyle.overflowMode = ellipsisMiddle
display.visualizations.charting.legend.mode = standard
display.visualizations.charting.legend.placement = right
display.visualizations.charting.lineWidth = 2
display.visualizations.custom.drilldown = all
display.visualizations.mapHeight = 400
display.visualizations.mapping.choroplethLayer.colorBins = 5
display.visualizations.mapping.choroplethLayer.colorMode = auto
display.visualizations.mapping.choroplethLayer.maximumColor = 0xaf575a
display.visualizations.mapping.choroplethLayer.minimumColor = 0x62b3b2
display.visualizations.mapping.choroplethLayer.neutralPoint = 0
display.visualizations.mapping.choroplethLayer.shapeOpacity = 0.75
display.visualizations.mapping.choroplethLayer.showBorder = 1
display.visualizations.mapping.data.maxClusters = 100
display.visualizations.mapping.drilldown = all
display.visualizations.mapping.legend.placement = bottomright
display.visualizations.mapping.map.center = (0,0)
display.visualizations.mapping.map.panning = 1
display.visualizations.mapping.map.scrollZoom = 0
display.visualizations.mapping.map.zoom = 2
display.visualizations.mapping.markerLayer.markerMaxSize = 50
display.visualizations.mapping.markerLayer.markerMinSize = 10
display.visualizations.mapping.markerLayer.markerOpacity = 0.8
display.visualizations.mapping.showTiles = 1
display.visualizations.mapping.tileLayer.maxZoom = 7
display.visualizations.mapping.tileLayer.minZoom = 0
display.visualizations.mapping.tileLayer.tileOpacity = 1
display.visualizations.mapping.type = marker
display.visualizations.show = 0
display.visualizations.singlevalue.colorBy = value
display.visualizations.singlevalue.colorMode = none
display.visualizations.singlevalue.drilldown = none
display.visualizations.singlevalue.numberPrecision = 0
display.visualizations.singlevalue.rangeColors = ["0x53a051", "0x0877a6", "0xf8be34", "0xf1813f", "0xdc4e41"]
display.visualizations.singlevalue.rangeValues = [0,30,70,100]
display.visualizations.singlevalue.showSparkline = 1
display.visualizations.singlevalue.showTrendIndicator = 1
display.visualizations.singlevalue.trendColorInterpretation = standard
display.visualizations.singlevalue.trendDisplayMode = absolute
display.visualizations.singlevalue.unitPosition = after
display.visualizations.singlevalue.useColors = 0
display.visualizations.singlevalue.useThousandSeparators = 1
display.visualizations.singlevalueHeight = 115
display.visualizations.trellis.enabled = 0
display.visualizations.trellis.scales.shared = 1
display.visualizations.trellis.size = medium
display.visualizations.type = charting
durable.backfill_type = auto
durable.lag_time = 0
durable.max_backfill_intervals = 0
embed.enabled = 0
enableSched = 1
is_visible = 1
max_concurrent = 1
precalculate_required_fields_for_alerts = 1
realtime_schedule = 1
request.ui_dispatch_app = itsi_aiops_alerting_content_pack
request.ui_dispatch_view = search
restart_on_searchpeer_add = 1
run_n_times = 0
run_on_startup = 0
schedule_as = auto
schedule_priority = default
schedule_window = auto
search = | `service_kpi_list` \
| inputlookup append=true itsi_kpi_attributes  \
| stats first(*) AS * by serviceid, kpiid  \
\
```Set defaults for any pre-defined kpi attributes fields that you want to have a default```\
| eval default_alert_group=service_name\
| eval default_itsiInclude=`service_monitoring_itsi_include_default`\
| eval default_itsi_instruction=""\
| eval default_suppress_period=120\
| eval default_threshold=5\
\
\
```Any fields added to this foreach will have their values automatically copied to newly discovered kpis within this service. Any fields not listed here will default to the above specified defaults, otherwise null and must be manually modified```\
| foreach alert_group, itsiInclude [ | rename <<FIELD>> as copy_<<FIELD>> ]\
\
``` For any "copy fields", the following eventstats and foreach magic will preserve itsi_kpi_attribute settings for existing kpis and set defaults for newly detected services/kpis based on service defaults. Modify the `use_kpi_attributes_for_defaults` macro to true() if you would like default attributes to be based on what KPIs with the same name use (see docs for more info) ```\
| eval tmp_kpi_split=if(kpi_name!="ServiceHealthScore",kpi_name,null())\
| eval tmp_service_split=if(kpi_name="ServiceHealthScore",service_name,null())\
\
| eventstats values(copy_*) as tmp_kpi_* count(copy_*) AS tmp_kpi_*_count by tmp_kpi_split\
| eventstats values(copy_*) as tmp_service_* count(copy_*) AS tmp_service_*_count by tmp_service_split\
| eventstats values(tmp_service_*) AS tmp_service_* by service_name\
\
| foreach copy_*\
    [| eval <<FIELD>>=case(isnotnull(<<FIELD>>),<<FIELD>>,`use_kpi_attributes_for_defaults` AND tmp_kpi_<<MATCHSTR>>_count>=3 AND isnotnull(tmp_kpi_split) AND isnotnull(tmp_kpi_<<MATCHSTR>>) AND mvcount(tmp_kpi_<<MATCHSTR>>)=1,tmp_kpi_<<MATCHSTR>>,isnotnull(tmp_service_<<MATCHSTR>>),tmp_service_<<MATCHSTR>>,true(),null())\
     | rename <<FIELD>> as <<MATCHSTR>>]\
\
```With all fields now specified, apply default values to any currently null field values where a default was specified```\
| foreach default_* [| eval <<FIELD>>=coalesce(<<MATCHSTR>>,<<FIELD>>) | rename <<FIELD>> as <<MATCHSTR>>]\
\
| table serviceid, kpiid, service_name, kpi_name alert_group, itsi*, attr* threshold suppress_period\
| outputlookup override_if_empty=false itsi_kpi_attributes
skip_scheduled_realtime_idxc = 0
