<form version="1.1" theme="light">
  <label>Episode Deep Dive</label>
  <search id="time">
    <query>
    | makeresults | addinfo
  </query>
    <earliest>$time.earliest$</earliest>
    <latest>$time.latest$</latest>
    <done>
      <set token="start_time">$result.info_min_time$</set>
      <set token="end_time">$result.info_max_time$</set>
    </done>
  </search>
  <fieldset submitButton="false">
    <input type="time" token="time">
      <label></label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="dropdown" token="span">
      <label>Span</label>
      <choice value="1m">1m</choice>
      <choice value="5m">5m</choice>
      <choice value="10m">10m</choice>
      <choice value="60m">60m</choice>
      <default>1m</default>
      <initialValue>1m</initialValue>
    </input>
    <input type="text" token="title_str">
      <label>Title Search</label>
      <default>Alert Group: Alerting Test*</default>
      <initialValue>Alert Group: Alerting Test*</initialValue>
    </input>
    <input type="dropdown" token="active">
      <label>Active</label>
      <choice value="1 &quot;1&quot;">Yes</choice>
      <choice value="0 &quot;0&quot;">No</choice>
      <choice value="0 1 &quot;0&quot; &quot;1&quot;">Either</choice>
      <default>1 "1"</default>
      <initialValue>1 "1"</initialValue>
    </input>
  </fieldset>
  <row>
    <panel>
      <title>Episode History</title>
      <chart>
        <search>
          <query>| tstats c where index=itsi_grouped_alerts AND alert_group="Alerting*" by itsi_group_id alert_group
| rename itsi_group_id as _key
| lookup itsi_notable_group_user_lookup _key OUTPUT
| lookup itsi_notable_group_system_lookup _key OUTPUT
| eval state=mvindex(split("Unk,New,In Progress,Pending,Resolved,Closed,x,y,z", ","), status), duration_minutes=round((last_time-start_time)/60), start_time_bin=start_time
| bin start_time_bin span=15m
| streamstats c as position by start_time_bin
| eval start=strftime(start_time, "%b %d %T"), str=printf("%s Title:%s Status:%s Active:%s", start, title, state, is_active)
| rename start_time as start_epoch
| table str start_epoch position event_count</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="charting.chart">bubble</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">none</option>
        <option name="height">271</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel>
      <title>Episode List</title>
      <table>
        <search>
          <query>| inputlookup itsi_notable_group_system_lookup where title="$title_str$" AND  mod_time &gt; $start_time$ AND is_active IN($active$)
              | lookup itsi_notable_group_user_lookup _key
              | eval state=mvindex(split("Unk,New,In Progress,Pending,Resolved,Closed,x,y,z", ","), status)
              | eval Details=printf("(%s: %d) %s to %s", state, event_count, strftime(start_time, "%T, %b %d"), strftime(last_time, "%F %T")), k=_key
              | table is_active title Details k
              | rename is_active as Active, title as "Episode Title"</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="count">10</option>
        <option name="drilldown">cell</option>
        <option name="refresh.display">progressbar</option>
        <fields>["Active","Episode Title","Details"]</fields>
        <drilldown>
          <set token="itsi_group_id">$row.k$</set>
        </drilldown>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>Event Count by Entity</title>
      <chart>
        <search>
          <query>index="itsi_grouped_alerts" itsi_group_id="$itsi_group_id$" 
| bin _time span=$span$
| makecontinuous _time span=$span$
| stats c by _time entity_title
| xyseries _time entity_title c</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.chart">column</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.placement">right</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel>
      <title>Events by Correlation Search</title>
      <chart>
        <search>
          <query>index="itsi_grouped_alerts" itsi_group_id="$itsi_group_id$"
| bin _time span=$span$
| makecontinuous _time span=$span$
| stats c by _time source
| xyseries _time source c</query>
          <earliest>$time.earliest$</earliest>
          <latest>$time.latest$</latest>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>ITSI Grouped Alerts Events sort time desc. itsi_group_id=$itsi_group_id$</title>
      <input type="dropdown" token="source">
        <label>Source</label>
        <choice value="*">All</choice>
        <default>*</default>
        <initialValue>*</initialValue>
        <fieldForLabel>source</fieldForLabel>
        <fieldForValue>source</fieldForValue>
        <search>
          <query>| tstats c where index="itsi_grouped_alerts" itsi_group_id="$itsi_group_id$" by source</query>
        </search>
      </input>
      <input type="dropdown" token="entity_title">
        <label>Entity</label>
        <choice value="*">All</choice>
        <search>
          <query>| tstats c where index="itsi_grouped_alerts" itsi_group_id="$itsi_group_id$" by entity_title</query>
        </search>
        <default>*</default>
        <initialValue>*</initialValue>
        <fieldForLabel>entity_title</fieldForLabel>
        <fieldForValue>entity_title</fieldForValue>
      </input>
      <table>
        <search>
          <query>index="itsi_grouped_alerts" itsi_group_id="$itsi_group_id$" source=$source|s$ entity_title=$entity_title|s$
| sort - _time
| eval status=mvindex(split("Unknown,New,In Progress,Pending,Resolved,Closed", ","), status)
| eval severity=mvindex(split("Unknown,Info,Normal,Low,Medium,High,CRITICAL", ","), severity)
| foreach last*time [eval &lt;&lt;FIELD&gt;&gt;=case(&lt;&lt;FIELD&gt;&gt;==-1, "first alert", &lt;&lt;FIELD&gt;&gt; &gt; 0, strftime(&lt;&lt;FIELD&gt;&gt;, "%T %F"), 1==1, "-")]
| table _time entity_title status impact severity threshold suppress_period title source, send_alert</query>
          <earliest>$earliest$</earliest>
          <latest>$latest$</latest>
        </search>
        <option name="count">100</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
</form>
